# Session 03 Implementation Plan — X-Accurate Thread Preview

## Mission

Replace the generic preview rendering with an X-accurate layout model for single tweets and threads, including tweet spacing, connectors, media arrangements (1–4 images), intrinsic-dimension crop indicators, and video poster frames. Add tweet-mode preview so both content types get the same fidelity. Keep preview state synchronized with all thread operations reactively.

---

## Codebase State Assessment

### Current line counts

| File | Lines | Status |
|------|-------|--------|
| `ComposeModal.svelte` | 480 | OVER 400 limit (Session 02 artifact) |
| `ComposerShell.svelte` | 516 | OVER 400 limit (Session 02 artifact) |
| `ThreadComposer.svelte` | 426 | OVER 400 limit (D6 justified deviation) |
| `TweetPreview.svelte` | 191 | OK |
| `MediaSlot.svelte` | 293 | OK |
| `TweetEditor.svelte` | 327 | OK |
| `VoiceContextPanel.svelte` | 284 | OK |
| `ThreadCardActions.svelte` | 124 | OK |
| `FromNotesPanel.svelte` | 313 | OK |

### Current preview architecture

The thread preview is rendered inline in `ComposeModal.svelte` (lines 328–354): a `thread-layout` CSS grid places the editor left and a preview scroll container right. The preview uses `TweetPreview.svelte` (191 lines), which renders:
- Avatar placeholder, handle, tweet index
- Text content
- A basic media grid with **fixed `16:9` aspect ratio** for ALL image slots regardless of count or intrinsic dimensions

### Identified gaps (from charter)

| Gap | Current state |
|-----|---------------|
| Media grid doesn't match X | 1/2/3/4 all use same fixed 16:9 slot |
| No intrinsic dimension awareness | Portrait, landscape, square all crop identically |
| Tweet mode has no preview | Only thread mode shows a preview pane |
| Video shows raw `<video>` element | No play button overlay or poster frame |
| No crop expectation signal | Users surprised by how images appear after posting |

### Media pipeline analysis

- **Upload**: `api.media.upload(file)` → returns `{ path, media_type, size }`. **No dimensions** returned.
- **Serve**: `api.media.fileUrl(path)` → `GET /api/media/file?path=...` serves raw bytes with Content-Type header.
- **Tweet mode**: `TweetEditor.svelte` stores `AttachedMedia[]` with `previewUrl` (blob URL) and `mediaType`.
- **Thread mode**: `MediaSlot.svelte` stores local previews internally in a `Map<string, { url, type }>`, only exposes `media_paths: string[]` up through `ThreadComposer`.
- **Preview**: `TweetPreview.svelte` receives `mediaPaths: string[]` and uses `api.media.fileUrl(path)` to construct image URLs. No blob URL passthrough, no dimension awareness.

**Conclusion**: Intrinsic dimension detection must happen client-side by loading images in the preview component. Server-side metadata endpoint would require Rust changes and is deferred per the implementation plan's fallback scope cuts.

---

## Architecture Decisions

### D8: Client-side dimension detection only

Server returns no width/height. We detect dimensions client-side using `Image.onload` → `naturalWidth`/`naturalHeight`. This is fast for localhost-served media. A `mediaDimensions.ts` utility provides deterministic helper functions for layout calculation and crop severity assessment.

**Tradeoff**: First render shows the grid at assumed aspect ratios; actual crop indicators appear after image loads (~50ms for local files). Acceptable given the charter says "no placeholder UX" applies to dead controls, not to progressive rendering.

### D9: Unified compose layout for both modes

Currently, thread mode uses a two-column grid layout while tweet mode has no layout wrapper. Session 03 introduces a shared `.compose-layout` class in ComposeModal that wraps both modes identically: editor pane left, preview rail right, stacking vertically on mobile. This reduces template duplication and enables tweet-mode preview without adding lines.

### D10: Media URL resolution strategy

- **Tweet mode**: ComposeModal has `attachedMedia: AttachedMedia[]` with blob URLs. Pass these to ThreadPreviewRail → TweetPreview → MediaCropPreview for zero-latency rendering.
- **Thread mode**: Thread blocks only carry `media_paths: string[]`. MediaCropPreview uses `api.media.fileUrl(path)` to load images from the local server. Dimension detection happens on `<img>` load.
- No changes to MediaSlot's internal state or API required.

### D11: ComposeModal line count

After extracting preview logic to ThreadPreviewRail and replacing inline preview markup with component usage, ComposeModal drops from 480 to ~440 lines. This is still above the 400-line limit. The remaining bulk is in handler functions (auto-save, AI assist, notes generation, undo) that reference reactive state and cannot be easily extracted in Svelte 5. Documented as a continued justified deviation, consistent with D6 for ThreadComposer.

### D12: TweetPreview retained as shared card component

`TweetPreview.svelte` is kept (not replaced) because it provides the per-tweet card shell (avatar, handle, text, connector). It delegates media rendering to the new `MediaCropPreview` component. This maintains backward compatibility for any other consumers and keeps card rendering separate from media layout concerns.

---

## File Plan

### Files to create

| File | Est. lines | Purpose |
|------|-----------|---------|
| `dashboard/src/lib/components/composer/ThreadPreviewRail.svelte` | ~170 | Preview container for both tweet and thread modes |
| `dashboard/src/lib/components/composer/MediaCropPreview.svelte` | ~250 | X-accurate media grid with crop indicators and video poster frames |
| `dashboard/src/lib/utils/mediaDimensions.ts` | ~80 | Pure functions: dimension detection, crop severity, X layout constants |

### Files to modify

| File | Current lines | Est. after | Change summary |
|------|--------------|-----------|----------------|
| `ComposeModal.svelte` | 480 | ~440 | Replace inline preview with ThreadPreviewRail, add tweet-mode layout |
| `TweetPreview.svelte` | 191 | ~120 | Replace inline media grid with MediaCropPreview, add optional localPreviews prop |
| `docs/composer-mode.md` | 387 | ~430 | Add Preview Fidelity section |

### Files to create (docs)

| File | Purpose |
|------|---------|
| `docs/roadmap/typefully-beating-composer/session-03-handoff.md` | Handoff document |

### Files NOT modified (confirming scope)

| File | Reason |
|------|--------|
| `MediaSlot.svelte` | Thread media paths work through server URLs; no API surface change needed |
| `api.ts` | No new API endpoints; existing `media.fileUrl` suffices |
| `ComposerShell.svelte` | Out of scope; pre-existing size violation from Session 02 |
| `ThreadComposer.svelte` | Out of scope; pre-existing size violation from Session 02 |
| Any Rust files | No server changes; dimension detection is client-side |

---

## Detailed Task Breakdown

### Task 3.1: Create `mediaDimensions.ts` utility

**File**: `dashboard/src/lib/utils/mediaDimensions.ts`
**Estimated lines**: ~80

This utility provides pure, deterministic functions used by MediaCropPreview. No framework dependencies — pure TypeScript.

**Exports**:

```typescript
/** Intrinsic dimensions of a media item */
export interface MediaDimensions {
  width: number;
  height: number;
}

/** X's slot aspect ratios per media count */
export const X_SLOT_RATIOS: Record<number, number[]>;
// 1 → [16/9]           (single image: ~1.778)
// 2 → [4/5, 4/5]       (side by side: ~0.8 each)
// 3 → [2/3, 1/1, 1/1]  (left tall, right stacked)
// 4 → [1/1, 1/1, 1/1, 1/1]  (2x2 grid)

/** Load image dimensions from a URL. Returns null for non-image or load failure. */
export function loadImageDimensions(url: string): Promise<MediaDimensions | null>;

/** Calculate how severely a slot will crop the image.
 *  Returns a value 0..1 where 0 = no crop, 1 = extreme crop.
 *  Values > 0.3 are considered "significant" for the crop indicator. */
export function calculateCropSeverity(
  intrinsic: MediaDimensions,
  slotAspectRatio: number
): number;

/** Check if a file path looks like a video */
export function isVideoPath(path: string): boolean;
```

**Rationale**: Extracting layout constants and math into a utility makes future preview tweaks deterministic and testable without touching component code. The charter Task 5 explicitly asks for this.

**Order**: First, because MediaCropPreview depends on it.

---

### Task 3.2: Create `MediaCropPreview.svelte`

**File**: `dashboard/src/lib/components/composer/MediaCropPreview.svelte`
**Estimated lines**: ~250

**Props**:
```typescript
{
  mediaPaths: string[];                    // Server paths (from ThreadBlock.media_paths or AttachedMedia[].path)
  localPreviews?: Map<string, string>;     // path → blob URL (for tweet mode, faster than server fetch)
}
```

**Behavior**:

1. **URL resolution**: For each path, check `localPreviews` first; fall back to `api.media.fileUrl(path)`.

2. **Grid layout** (CSS Grid, matching X's patterns):

   | Count | CSS grid-template | Slot aspect ratios |
   |-------|-------------------|--------------------|
   | 1 | `1fr / 1fr` | 16:9 |
   | 2 | `1fr 1fr / 1fr` | 4:5 each |
   | 3 | `1fr 1fr / 1fr 1fr` (first-child spans row 1/3) | Left: 2:3, Right top/bottom: 1:1 |
   | 4 | `1fr 1fr / 1fr 1fr` | 1:1 each |

3. **Intrinsic dimension detection**: On `<img>` load, read `naturalWidth`/`naturalHeight`. Store in a reactive `Map<string, MediaDimensions>` keyed by path.

4. **Crop indicator**: When `calculateCropSeverity(intrinsic, slotRatio) > 0.3`, render a subtle overlay — a small "cropped" text badge in the bottom-right corner of the slot with semi-transparent background. Not a full overlay — just a hint.

5. **Video poster frame**: For video paths:
   - Render `<video preload="metadata">` to extract first frame as poster
   - Overlay a centered play button icon (inline SVG circle + triangle)
   - No playback controls; visual representation only
   - `object-fit: cover` to fill the slot

6. **Edge cases**:
   - Empty `mediaPaths` → render nothing (component returns empty)
   - More than 4 paths → only render first 4 (X's limit)
   - Image load failure → show fallback placeholder (gray fill with image icon)

**Style architecture**:
- Grid container: rounded corners, 4px gap, 1px border matching `--color-border-subtle`
- Each slot uses `overflow: hidden` for clean cropping
- All images use `object-fit: cover` (matches X behavior)
- Crop indicator: `position: absolute`, bottom-right, `font-size: 10px`, semi-transparent dark background
- Video play overlay: centered, white circle with play triangle, matches X's visual style
- Mobile: same grid structure at smaller scale (responsive via container width)
- `prefers-reduced-motion`: no transition on crop indicator

---

### Task 3.3: Create `ThreadPreviewRail.svelte`

**File**: `dashboard/src/lib/components/composer/ThreadPreviewRail.svelte`
**Estimated lines**: ~170

**Props**:
```typescript
{
  mode: 'tweet' | 'thread';
  // Tweet mode
  tweetText?: string;
  tweetMediaPaths?: string[];
  tweetLocalPreviews?: Map<string, string>;   // blob URLs for tweet media
  // Thread mode
  blocks?: Array<{ id: string; text: string; media_paths: string[] }>;
  // Shared
  handle?: string;
}
```

**Behavior**:

1. **Thread mode**: Renders a scrollable list of `TweetPreview` cards (the same pattern currently inline in ComposeModal lines 337–354). Shows "Start typing to see preview..." empty state when no non-empty blocks exist.

2. **Tweet mode**: Renders a single `TweetPreview` card showing the current tweet text and attached media. Shows "Type to see preview..." empty state when text is empty and no media attached.

3. **Shared chrome**: "Preview" header label above the preview content.

4. **Scroll container**: `max-height: 400px` with `overflow-y: auto` (matching current thread preview behavior). In focus mode, should expand to fill available space.

5. **Preview synchronization**: Component is purely derived from props — no internal state related to content. All thread operations (reorder, split, merge, delete, recovery) propagate through the reactive `blocks` prop. No special sync logic needed.

**Why one component for both modes**: The charter explicitly asks for "tweet-mode preview" that matches thread mode. Using a single container component avoids duplicating the scroll wrapper, header, empty state, and mobile stacking logic.

---

### Task 3.4: Modify `TweetPreview.svelte`

**File**: `dashboard/src/lib/components/TweetPreview.svelte`
**Current lines**: 191 → **Estimated after**: ~120

**Changes**:

1. **Replace inline media grid** (lines 42–56, styles 128–169) with a single `<MediaCropPreview>` component usage:
   ```svelte
   {#if hasMedia}
     <MediaCropPreview {mediaPaths} {localPreviews} />
   {/if}
   ```

2. **Add optional `localPreviews` prop**:
   ```typescript
   localPreviews?: Map<string, string>;  // path → blob URL
   ```
   Pass through to MediaCropPreview.

3. **Remove**: All `.preview-media-grid` CSS classes and media-item styles (~40 lines of CSS removed).

4. **Keep**: Avatar, handle, text, thread connector, accessibility attributes, mobile responsive styles.

5. **Backward compatibility**: The `index` and `total` props still control connector visibility and display numbering. No API change for existing consumers.

---

### Task 3.5: Modify `ComposeModal.svelte`

**File**: `dashboard/src/lib/components/ComposeModal.svelte`
**Current lines**: 480 → **Estimated after**: ~440

**Template changes**:

1. **Replace thread-mode layout** (lines 328–354) with unified `compose-layout`:
   ```svelte
   <div class="compose-layout">
     <div class="editor-pane">
       {#if mode === 'tweet'}
         <TweetEditor ... />
       {:else}
         <ThreadComposer ... />
       {/if}
     </div>
     <ThreadPreviewRail
       {mode}
       tweetText={tweetText}
       tweetMediaPaths={attachedMedia.map(m => m.path)}
       tweetLocalPreviews={tweetMediaPreviewMap}
       blocks={sortedPreviewBlocks}
     />
   </div>
   ```

2. **Add `tweetMediaPreviewMap` derived**:
   ```typescript
   const tweetMediaPreviewMap = $derived(
     new Map(attachedMedia.map(m => [m.path, m.previewUrl]))
   );
   ```
   This passes blob URLs from tweet-mode media to the preview rail for instant rendering.

3. **Import ThreadPreviewRail** (add to imports, remove direct TweetPreview import).

4. **Remove replaced CSS classes**: `.thread-layout`, `.thread-editor-pane`, `.thread-preview-pane`, `.preview-header-label`, `.preview-scroll`, `.preview-empty`.

5. **Add new CSS classes**: `.compose-layout` (two-column grid), `.editor-pane` (min-width: 0), mobile media query to stack columns.

6. **Remove `sortedPreviewBlocks` workaround**: ThreadPreviewRail handles the empty-state check internally, so the derived value can be simplified or kept as-is for data flow.

**Net effect**: ~39 lines saved from template/CSS extraction, ~10 lines added for new layout + derived state. Total reduction: ~29 lines.

---

### Task 3.6: Update `docs/composer-mode.md`

**Add a new section**: "## Preview Fidelity" between "## Auto-Save & Recovery" and "## Voice Context" (or at the end before "## Troubleshooting").

**Content**:

1. **What the preview emulates**:
   - X's media grid layouts for 1, 2, 3, and 4 image arrangements
   - Tweet connectors for threads (vertical line between cards)
   - Avatar placeholder, handle, tweet numbering
   - Video poster frame with play icon overlay
   - Crop severity indicator for significantly cropped images

2. **Media grid rules** (table showing count → grid → slot aspect ratio).

3. **Crop indicator**: Explain that a small "cropped" badge appears when an image's intrinsic aspect ratio deviates >30% from the display slot, helping users anticipate how their image will appear on X.

4. **Tweet-mode preview**: Both tweet and thread modes now show a live preview alongside the editor. Desktop: side-by-side. Mobile: stacked vertically.

5. **Known limitations**:
   - No URL unfurling / link card preview
   - No GIF animation toggle
   - No quote-tweet or poll preview
   - Crop indicator shows after image loads (brief delay)
   - Preview follows app theme (no independent dark/light toggle)

6. **Preview fidelity constants**: Reference the `mediaDimensions.ts` utility for the exact aspect ratios used.

---

### Task 3.7: Write session handoff

**File**: `docs/roadmap/typefully-beating-composer/session-03-handoff.md`

Document: what changed, decisions made, quality gate results, what remains, files Session 04 must read.

---

## Order of Operations

| Step | Task | Dependencies | Verification |
|------|------|-------------|--------------|
| 1 | Create `mediaDimensions.ts` | None | Exports compile, constants are correct |
| 2 | Create `MediaCropPreview.svelte` | Step 1 | Component renders all 4 grid layouts, `npm run check` passes |
| 3 | Modify `TweetPreview.svelte` | Step 2 | Replaces inline grid with MediaCropPreview, `npm run check` passes |
| 4 | Create `ThreadPreviewRail.svelte` | Step 3 | Renders both modes, `npm run check` passes |
| 5 | Modify `ComposeModal.svelte` | Steps 3, 4 | Unified layout, tweet-mode preview works, `npm run check` passes |
| 6 | Run full quality gates | Steps 1–5 | `npm run check` + `npm run build` pass |
| 7 | Update `docs/composer-mode.md` | Steps 1–5 | Section is accurate to implemented behavior |
| 8 | Write `session-03-handoff.md` | Steps 1–7 | Lists all changes, quality gate results, Session 04 inputs |

**Rationale for order**: Bottom-up. Utilities first, then leaf components, then container components, then orchestrator. Each step has an independent verification point so failures are caught early.

---

## Risks and Mitigations

### R1: ComposeModal exceeds 400-line limit after changes
**Likelihood**: High (estimated ~440 lines)
**Impact**: Low — CI doesn't enforce line counts; it's a style rule.
**Mitigation**: Extract as much preview-related CSS and template as possible. Document the deviation in the handoff (consistent with D6 for ThreadComposer). Note: further reduction would require restructuring auto-save or AI assist handlers, which is outside Session 03 scope.

### R2: Image dimension detection causes visible layout shift
**Likelihood**: Medium — images load from localhost so latency is low (~50ms), but there may be a brief flicker.
**Impact**: Medium — visible layout shift on initial render.
**Mitigation**: Set the CSS grid cells to fixed aspect ratios (matching X's expected ratios) from the start. The crop indicator fades in after dimension detection, but the grid layout never shifts. Images render with `object-fit: cover` immediately.

### R3: Video poster frame extraction fails silently
**Likelihood**: Low — `preload="metadata"` is widely supported.
**Impact**: Low — video shows as black rectangle with play icon.
**Mitigation**: Always show the play icon overlay regardless of whether `loadeddata` fires. If the poster frame fails, the play icon on a dark background is still a clear video indicator (better than the current raw `<video>` element).

### R4: Thread operations cause stale preview state
**Likelihood**: Very low — the preview is purely derived from the reactive `blocks` prop.
**Impact**: High — stale preview is worse than no preview.
**Mitigation**: ThreadPreviewRail takes `blocks` as a prop (not internal state). All thread operations (reorder, split, merge, delete, recovery) propagate through ComposeModal's `sortedPreviewBlocks` derived value, which is already reactive. No special sync logic needed. Verify this during implementation by testing each operation.

### R5: MediaCropPreview grows beyond 250 lines
**Likelihood**: Medium — four grid layouts + crop indicator + video poster + error handling is substantial.
**Impact**: Low if under 400 lines.
**Mitigation**: If approaching 350+ lines, extract the video poster frame rendering into a small `VideoThumb` snippet (Svelte 5 `{#snippet}`) within the same file, or a separate component. Grid CSS can be kept compact with CSS Grid shorthand.

### R6: Existing consumers of TweetPreview break
**Likelihood**: Very low — TweetPreview is only imported by ComposeModal and ThreadPreviewRail (new). After changes, it's imported by ThreadPreviewRail only. ComposeModal switches to importing ThreadPreviewRail.
**Impact**: Medium — broken preview rendering.
**Mitigation**: Grep for all TweetPreview imports before modifying the component. Add the new `localPreviews` prop as optional with a default, ensuring backward compatibility.

---

## Verification Steps

### During implementation (after each task)
```bash
cd dashboard && npm run check
```

### After all code changes (Step 6)
```bash
cd dashboard && npm run check    # svelte-check: 0 errors
cd dashboard && npm run build    # vite build: success
```

### No Rust changes expected
If any Rust files are modified (not planned), run:
```bash
cargo fmt --all && cargo fmt --all --check
RUSTFLAGS="-D warnings" cargo test --workspace
cargo clippy --workspace -- -D warnings
```

### Manual verification checklist
- [ ] Thread mode: preview renders 2+ cards with text and connectors
- [ ] Thread mode: 1-image grid shows 16:9 crop
- [ ] Thread mode: 2-image grid shows side-by-side
- [ ] Thread mode: 3-image grid shows large left + 2 stacked right
- [ ] Thread mode: 4-image grid shows 2×2
- [ ] Tweet mode: preview appears alongside editor on desktop
- [ ] Tweet mode: preview stacks below editor on mobile (<768px)
- [ ] Tweet mode: media renders with X-accurate grid
- [ ] Crop indicator appears for portrait images in landscape slots
- [ ] Video shows poster frame + centered play icon
- [ ] Thread reorder (drag/keyboard) updates preview immediately
- [ ] Thread split updates preview immediately
- [ ] Thread merge updates preview immediately
- [ ] Thread delete updates preview immediately
- [ ] Draft recovery restores preview correctly
- [ ] Focus mode: preview expands to fill available space
- [ ] Empty state: "Type to see preview..." for tweet / "Start typing to see preview..." for thread
- [ ] All files under 400 lines or documented as justified deviation

---

## Fallback Scope Cuts (priority order, per implementation plan)

If time-constrained, cut in this order:

1. **Cut first**: Crop indicator overlay — keep `object-fit: cover` with no severity feedback. MediaCropPreview still renders correct grids but doesn't show the "cropped" badge. `mediaDimensions.ts` still created (needed for future reference) but `calculateCropSeverity` not called.

2. **Cut second**: Video poster frame — show generic video placeholder (dark rectangle with play icon SVG, no `<video preload="metadata">`). Simpler CSS-only approach.

3. **Cut third**: Intrinsic dimension detection — remove `mediaDimensions.ts` entirely. MediaCropPreview uses only CSS `aspect-ratio` on slots with `object-fit: cover`. All images render correctly but crop indicator never appears.

**Minimum viable Session 03**: X-accurate CSS grid layouts (1/2/3/4) + tweet-mode preview pane + ThreadPreviewRail extraction + docs. This alone beats generic composer previews.

---

## Component Hierarchy After Session 03

```
ComposeModal.svelte (~440 lines, orchestrator — D11 justified)
├── ComposerShell.svelte (516 lines, modal chrome — pre-existing D6-adjacent)
│   └── [header, tabs, body, footer]
├── VoiceContextPanel.svelte (284 lines)
├── compose-layout (CSS Grid: editor | preview)
│   ├── editor-pane
│   │   ├── TweetEditor.svelte (327 lines) — tweet mode
│   │   └── ThreadComposer.svelte (426 lines, D6 justified) — thread mode
│   │       ├── MediaSlot.svelte (293 lines) — per-card media
│   │       └── ThreadCardActions.svelte (124 lines)
│   └── ThreadPreviewRail.svelte (~170 lines) — NEW
│       └── TweetPreview.svelte (~120 lines, modified)
│           └── MediaCropPreview.svelte (~250 lines) — NEW
├── FromNotesPanel.svelte (313 lines) — overlay
├── TimePicker.svelte — schedule section
└── CommandPalette.svelte — overlay

Utility:
  dashboard/src/lib/utils/mediaDimensions.ts (~80 lines) — NEW
```

---

## Session 03 → Session 04 Contract

Session 03 delivers:
1. ThreadPreviewRail with tweet + thread preview support
2. MediaCropPreview with X-accurate 1/2/3/4 grids
3. Intrinsic dimension detection + crop indicator (if not cut)
4. Video poster frame (if not cut)
5. Updated docs/composer-mode.md with Preview Fidelity section
6. Session handoff with exact change manifest

Session 04 must validate:
- All manual checklist items above
- File size audit (note justified deviations)
- No regressions in thread CRUD, auto-save/recovery, keyboard shortcuts
- Approval mode still routes through queue
- Scheduling flow unchanged
- Mobile layout usable on both modes
- `npm run check` + `npm run build` pass
- Full Rust CI suite (if any Rust changes occurred in any session)
