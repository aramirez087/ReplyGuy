# Session 4 Plan: Validation and Release Readiness

## Mission

Validate the factory-reset epic end-to-end, reconcile all artifacts with
shipped code, and publish a go/no-go release report with exact follow-up
items.

## Pre-Implementation Assessment

After reading all anchors, handoffs (Sessions 01-03), and tracing every
code path, the feature is fully implemented across 3 prior sessions:

- **Session 1:** Charter, scope, table audit, FK ordering, file plan.
- **Session 2:** Backend -- `storage/reset.rs`, handler in `settings.rs`,
  route in `lib.rs`, 5 unit + 7 integration tests, `reset-contract.md`.
- **Session 3:** Frontend -- `DangerZoneSection.svelte`, `factoryReset()`
  API method, `clearSession()`, `resetStores()`, `disconnectWs()`, nav
  integration, `frontend-flow.md`.

Session 4 is a **validation-only session**. It creates two documentation
deliverables and fixes any CI regressions found during quality gate checks.

---

## Order of Operations

### Step 1: Run All Quality Gates

Run the full CI checklist to confirm no regressions since Session 3.

```bash
cargo fmt --all && cargo fmt --all --check
RUSTFLAGS="-D warnings" cargo test --workspace
cargo clippy --workspace -- -D warnings
cd dashboard && npm run check && npm run build
```

**Expected outcome:** All gates pass (Session 3 reported clean).

**If any gate fails:** Fix the regression before proceeding. The fix scope
is limited to whatever broke since Session 3 -- no new features. Document
the fix in the release readiness report.

### Step 2: Verify Critical Path (Code Audit)

Trace the end-to-end flow through code without running the app. Verify:

#### 2a. Configured instance -> Danger Zone

- `+layout.svelte` (line 36-38): Bearer mode checks `configStatus()`,
  redirects to `/onboarding` if `configured=false`. If configured, allows
  through to settings.
- `+page.svelte` (line 55): `{ id: 'danger', label: 'Danger', icon: AlertTriangle }`
  in sections array -- nav entry exists.
- `+page.svelte` (line 191): `<DangerZoneSection />` rendered after
  `<LanAccessSection />`.
- **Verified.**

#### 2b. Confirmed reset

- `DangerZoneSection.svelte` (line 16): `canReset` derived from exact
  match `confirmationText === CONFIRMATION_PHRASE && !resetting`.
- Button disabled until `canReset` is true (line 89).
- `handleReset()` (line 18-35): calls `api.settings.factoryReset()`.
- `api.ts` (line 916-923): sends `POST /api/settings/factory-reset` with
  `{ confirmation }` body.
- Server handler (settings.rs line 441-536): validates phrase, stops
  runtimes, clears DB (30 tables in FK-safe order in single tx), deletes
  config/passphrase/media files, clears in-memory state, returns response
  with `Set-Cookie: Max-Age=0`.
- **Verified.**

#### 2c. Reset -> Onboarding redirect

- On success: `clearSession()` -> `resetStores()` -> `disconnectWs()` ->
  `goto('/onboarding')` with `window.location.href` fallback.
- **Verified.**

#### 2d. Fresh init path after reset

- `+layout.svelte` (line 36-38/50-58): checks `configStatus()`. After
  reset, `configured=false` and `claimed=false`.
  - Bearer mode: redirects to `/onboarding`.
  - Cookie mode: redirects to `/onboarding` (no `?claimed=1` since
    `claimed=false`).
- Onboarding wizard works normally. `POST /api/settings/init` is
  auth-exempt. Creates new config.toml and optionally new passphrase.
- Integration test `factory_reset_allows_re_onboarding` confirms this
  path (factory_reset.rs line 334-355).
- **Verified.**

### Step 3: Confirm No Accessible User Data After Reset

Trace what is cleared vs preserved against the charter:

| Charter Requirement | Implementation | Verified |
|---------------------|----------------|----------|
| All 30 user tables cleared | `TABLES_TO_CLEAR` has 30 entries, `tables_to_clear_covers_all_user_tables` test validates against `sqlite_master` | Yes |
| `_sqlx_migrations` preserved | Not in `TABLES_TO_CLEAR`, dedicated test | Yes |
| `config.toml` deleted | Handler line 471-478, `remove_file` with NotFound tolerance | Yes |
| `passphrase_hash` file deleted | Handler line 481-489, `remove_file` with NotFound tolerance | Yes |
| `passphrase_hash` in-memory cleared | Handler line 503, `*state.passphrase_hash.write().await = None` | Yes |
| `media/` directory deleted | Handler line 492-500, `remove_dir_all` with NotFound tolerance | Yes |
| Sessions cleared (DB) | `sessions` table is in `TABLES_TO_CLEAR` (position 29) | Yes |
| Session cookie cleared | Handler line 530, `Set-Cookie: Max-Age=0` | Yes |
| Runtimes stopped | Handler line 453-460, `drain()` with `shutdown()` | Yes |
| Watchtower cancelled | Handler line 463-465, `token.cancel()` | Yes |
| Content generators cleared | Handler line 504 | Yes |
| Login attempts cleared | Handler line 505 | Yes |
| `api_token` preserved | Not in any deletion path | Yes |
| DB schema preserved | DELETE not DROP, dedicated test | Yes |
| `backups/` preserved | Not in any deletion path | Yes |
| No content source folders touched | Not in any deletion path | Yes |

### Step 4: Confirm Auth Protection

- `/api/settings/factory-reset` is NOT in `AUTH_EXEMPT_PATHS` (verified
  in `auth/middleware.rs` lines 35-49).
- Integration test `factory_reset_requires_auth` sends POST without auth
  and asserts 401.
- Bearer and cookie+CSRF paths both covered by standard middleware.
- **Verified: destructive action is behind auth and CSRF.**

### Step 5: Reconcile Artifacts with Code

Check each artifact for divergence from shipped code:

#### 5a. `charter.md`

- **VACUUM step:** Charter lists VACUUM as step 7 in execution order.
  Session 2 decided to skip VACUUM (documented in session-02-handoff).
  The code does NOT run VACUUM. **Divergence -- charter mentions it, code
  skips it.** Update charter to note VACUUM was dropped.
- Everything else matches.

#### 5b. `reset-contract.md`

- Endpoint, request body, response shape, error codes, post-reset
  behavior, cleared/preserved lists all match the code exactly.
- **No divergence.**

#### 5c. `frontend-flow.md`

- User journey, confirmation UX, auth mode handling, state cleanup
  sequence, known limitations all match `DangerZoneSection.svelte`.
- **No divergence.**

### Step 6: Write Release Readiness Report

Create `docs/roadmap/factory-reset-danger-zone/release-readiness.md` with:

- Summary of all quality gate results.
- Artifact-vs-code reconciliation results.
- Critical path verification results.
- Residual risks and known limitations.
- Go/no-go decision with rationale.
- Follow-up items list (post-release enhancements).

### Step 7: Write Session 04 Handoff

Create `docs/roadmap/factory-reset-danger-zone/session-04-handoff.md` with:

- Completed work summary.
- CI results.
- Artifact updates made (if any).
- Release decision.
- Optional future work items.

---

## Files to Create

| File | Purpose |
|------|---------|
| `docs/roadmap/factory-reset-danger-zone/release-readiness.md` | Go/no-go release report |
| `docs/roadmap/factory-reset-danger-zone/session-04-handoff.md` | Final session handoff |

## Files to Potentially Modify

| File | Condition |
|------|-----------|
| `docs/roadmap/factory-reset-danger-zone/charter.md` | Only if VACUUM divergence needs annotation |
| Any source file | Only if quality gates fail (regression fix) |

**No source code files should be created or modified** unless a quality
gate reveals a regression that must be fixed.

---

## Key Design Decisions

| Decision | Rationale |
|----------|-----------|
| Validation-only session (no new code) | All implementation is complete from Sessions 2-3. Session 4 is verification and release gating. |
| Code audit over manual testing | Automated tests cover all critical paths. Code tracing verifies flows that require running server + frontend together. |
| Charter annotation over rewrite | The VACUUM omission is a documented decision from Session 2. Annotate rather than rewrite to preserve decision history. |
| Go recommendation expected | All tests pass, all code paths verified, all artifacts aligned. No blockers identified in code review. |

---

## Risks

| Risk | Likelihood | Mitigation |
|------|-----------|------------|
| CI regression since Session 3 | Low | Run full quality gates first; fix before proceeding |
| New migration added since Session 3 adds a table not in `TABLES_TO_CLEAR` | Low | `tables_to_clear_covers_all_user_tables` test catches this automatically |
| VACUUM annotation in charter creates confusion | Low | Clear inline note explaining the decision and pointing to session-02-handoff |

---

## Verification Steps

1. `cargo fmt --all && cargo fmt --all --check` -- formatting clean.
2. `RUSTFLAGS="-D warnings" cargo test --workspace` -- all tests pass,
   including the 5 core reset tests and 7 integration tests.
3. `cargo clippy --workspace -- -D warnings` -- no warnings.
4. `cd dashboard && npm run check` -- svelte-check passes (pre-existing
   warnings acceptable).
5. `cd dashboard && npm run build` -- production build succeeds.
6. Manual code trace of critical path (Steps 2a-2d above) documented in
   release readiness report.

---

## Estimated Work

This session is documentation-heavy with minimal code risk:

1. Run quality gates (4 commands).
2. Trace critical path through code (already done in this plan).
3. Write `release-readiness.md` (~100-150 lines).
4. Optionally annotate `charter.md` (1-2 lines for VACUUM note).
5. Write `session-04-handoff.md` (~60-80 lines).

Total: 2 new files, 0-1 modified files, 0 source code changes expected.
